{% for upstream in nginx_upstreams %}
upstream {{ upstream.name }} {
{% if upstream.strategy is defined %}
    {{ upstream.strategy }};
{% endif %}
{% for server in upstream.servers %}
    server {{ server }};
{% endfor %}
}
{% endfor %}

# Servers
{% for server in servers %}
{% set server_name = item.server_name if server.server_name is string else server.server_name | first %}
server {

{% if server.listen is defined %}
    listen {{ server.listen }};
{% endif %}
{% if server.server_name is defined and server.server_name is string %}
    server_name {{ server.server_name }};
{% elif server.server_name is defined %}
    server_name {{ server.server_name | join(' ') }};
{% endif %}
{% if server.no_root is not defined %}
    root {{ project_html_path }}/{{ project_root }};
{% endif %}

{% if server.no_log is not defined %}
    # Log
    access_log  {{ project_logs_path }}/nginx_access.log;
    error_log   {{ project_logs_path }}/nginx_error.log debug;
{% endif %}

{% if server.certificate is defined and server.certificate_key is defined %}
    # SSL
    ssl {{ server.ssl | default('on') }};
    ssl_certificate      {{ project_ssl_path }}/{{ server_name }}-bundled.crt;
    ssl_certificate_key  {{ project_ssl_path }}/{{ server_name }}.key;

    ssl_session_cache           shared:SSL:20m;
    ssl_session_timeout         10m;
    ssl_protocols               TLSv1 TLSv1.1 TLSv1.2;
    ssl_prefer_server_ciphers   on;
    ssl_ciphers                 ECDH+AESGCM:ECDH+AES256:ECDH+AES128:DH+3DES:!ADH:!AECDH:!MD5;

    ssl_dhparam                 {{ project_dhparam_file }};

    ssl_stapling {{ server.ssl_stapling | default('on') }};
    ssl_stapling_verify {{ server.ssl_stapling_verify | default('on') }};
    ssl_trusted_certificate {{ project_ssl_path }}/{{ server_name }}-trustchain.crt;
    resolver 8.8.8.8 8.8.4.4;
{% endif %}

{% if server.inline is defined %}
    {{ server.inline }}
{% endif %}

{% if server.includes is defined %}
{% for path in server.includes %}
    include     {{ project_config_path }}/{{ path }};
{% endfor %}
{% endif %}
}


{% endfor %}
